#!/usr/bin/env python
"""igcommit - InnoGames Commit Validation Script

This the pre-receive script for Git repositories to validate pushed commits
on the server side.

Copyright (c) 2016, InnoGames GmbH
"""

from igcommit import commit_checks, file_checks
from igcommit.commit_list import CommitList


commits = CommitList.read_from_input()
if not all(commits):
    raise SystemExit('New commits with deletes')

checks = commits.expand_checks_all((
    commit_checks.CheckDuplicateCommitSummaries(),
    commit_checks.CheckMisleadingMergeCommit(),
    commit_checks.CheckCommitMessage(),
    commit_checks.CheckCommitSummary(),
    commit_checks.CheckCommitTags(),
    commit_checks.CheckChangedFilePaths(),
    file_checks.CheckExecutable(),
    file_checks.CheckCommand(
        (
            'puppet',
            'parser',
            'validate',
            '--color=false',
            '--confdir=/tmp',
            '--vardir=/tmp',
        ),
        extension='pp',
    ),
    file_checks.CheckCommand(
        (
            'puppet-lint',
            '--fail-on-warnings',
            '--no-autoloader_layout-check',
            '/dev/stdin',
        ),
        extension='pp',
    ),
    file_checks.CheckCommand(
        ('flake8', '/dev/stdin'),
        extension='py',
    ),
    file_checks.CheckCommand(
        ('rubocop', '--format=emacs', '--stdin', '/dev/stdin'),
        extension='rb',
    ),
    file_checks.CheckCommand(
        ('shellcheck', '--format=gcc', '/dev/stdin'),
        extension='sh',
    ),
    file_checks.CheckCommandWithConfig(
        ('jscs', '--max-errors=-1', '--reporter=unix', '/dev/stdin'),
        extension='js',
        config_name='.jscs.json',
    ),
))

failed = False
for check in checks:
    check.print_problems()
    if check.failed:
        failed = True

if failed:
    raise SystemExit('Checks failed')
